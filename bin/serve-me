#!/usr/bin/env ruby

require 'rubygems'
require 'sinatra'

set :static, true
set :root, Dir.pwd
set :public, Dir.pwd

helpers do
  def _(path)
    path.gsub(File.expand_path(Dir.pwd), '')
  end
end

['/', '/:path'].each do |route|
  get route do
    dir = [Dir.pwd, params[:path], '*'].compact.join('/')
    @files = Dir[dir].join("\n")
    erb :index
  end
end

__END__

@@ layout
<html>
<head>
  <title>Viewing <%= params[:path] || Dir.pwd %>/</title>
  <style type="text/css" media="screen">
    body {
      font-family: Helvetica;
      padding: 0 1em;
    }

    a {
      text-decoration: none;
      font-family: Bitstream Vera Sans Mono;
      background: #eef;
      padding: 3px;
      color: #000;
    }

    a:hover {
      background: #555;
      color: #fff;
    }

    a:active {
      background: #333;
    }

    code {
      font-family: Bitstream Vera Sans Mono;
      background: #eef;
      padding: 3px;
    }
  </style>
</head>
<body>
  <%= yield %>
</body>
</html>

@@ index
<h1>Viewing <code><%= params[:path] || Dir.pwd %>/</code></h1>

<% @files.each do |file| %>
  <h3><a href ="<%= _(file) %>"><%= _(file) %></a></h3>
<% end %>

<% if params[:path] %>
<a href="/<%= _(Dir.pwd + params[:path] + '/..') %>">Back</a>
<% end %>
