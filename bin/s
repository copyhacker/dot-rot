#!/usr/bin/env ruby

require 'rubygems'
require 'sinatra'
require 'rack-flash'

set :static, true
set :root, Dir.pwd
set :public, Dir.pwd

enable :sessions

use Rack::Flash

def route(path)
  if prefix = ARGV.first
    '/' + prefix + path
  else
    path
  end
end

helpers do
  # Forward link
  def _(path, opts={})
    res = path.gsub(File.expand_path(Dir.pwd), '')
    if opts[:route] and File.directory?(path)
      route(res)
    else
      res
    end
  end

  # Back link
  def __(path)
    _(Dir.pwd + path + '/..')
  end
end

configure do
  $RUNNING = []
end

['/', '/:path'].each do |path|
  get route(path) + '?' do
    dir = [Dir.pwd, params[:path], '*'].compact.join('/')
    @files = Dir[dir]
    erb :index
  end
end

get '/run/*' do
  file = '/' + params[:splat].join('/')
  port = "678#{$RUNNING.length}"
  $RUNNING.push file
  flash[:port] = port
  Thread.new { `ruby #{file} -p #{port}` }
  redirect request.referrer
end

__END__

@@ layout
<html>
<head>
  <title>Viewing <%= params[:path] || Dir.pwd %>/</title>
  <style type="text/css" media="screen">
    body {
      font-family: Helvetica;
      padding: 0 1em;
    }

    a {
      text-decoration: none;
      font-family: Bitstream Vera Sans Mono;
      background: #eef;
      padding: 3px;
      color: #000;
    }

    a.run-app {
      background: #ffc;
    }

    a:hover {
      background: #555;
      color: #fff;
    }

    a:active {
      background: #333;
    }

    strong {
      background: #cfa;
      padding: 3px;
    }

    strong a {
      background: #cfa;
      color: #484;
    }

    code {
      font-family: Bitstream Vera Sans Mono;
      background: #eef;
      padding: 3px;
    }
  </style>
</head>
<body>
  <% if flash.has?(:port) %>
    <strong>
      Running on port <a href='http://localhost:<%= flash[:port] %>'><%= flash[:port] %></a>.
    </strong>
  <% end %>
  <%= yield %>
</body>
</html>

@@ index
<h1>
  Viewing <code><%= params[:path] || Dir.pwd %>/</code>
</h1>

<% if params[:path] %>
  <h3>
    <a href="<%= __(params[:path]) %>">/..</a>
  </h3>
<% end %>

<% @files.each do |file| %>
  <h3>
    <a href ="<%= _(file, :route => true) %>"><%= _(file) %></a>
    <% if file =~ /\.rb$/ and not $RUNNING.include?(file) %>
    <small>
      <a class="run-app" href="/run<%= file %>">Run app</a>
    </small>
    <% end %>
  </h3>
<% end %>

<% if params[:path] %>
  <a href="<%= __(params[:path]) %>">Back</a>
<% end %>
